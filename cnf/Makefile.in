#############################################################################
##
#W Makefile.in                                              Laurent Bartholdi
##
#Y Copyright (C) 2007-2012, Laurent Bartholdi
##
#############################################################################
##
##  This compiles the C/Java modules, creates archives, or
##  compiles the documentation
##
#############################################################################

.PHONY: all doc clean distribute mrproper checkblocks tarballs wwwdir

PWDU:=$(shell dirname $(PWD))
PWDUU:=$(shell dirname $(PWDU))

LOCALBIN=bin/@GAPARCH@
EXTERN=$(CURDIR)/bin/@GAPARCH@/extern
MPFRLIB=extern/mpfr-3.1.1
MPFILIB=extern/mpfi-1.5.1
MPCLIB=extern/mpc-1.0.1
CXSCLIB=extern/cxsc-2-5-3
FPLLLLIB=extern/libfplll-4.0.1

MYCC=./libtool --mode=compile --tag=CC $(CC) $(CFLAGS) @CFLAGS@ @GAP_CPPFLAGS@ -std=c99 -g -Wall
MYCXX=error
MYLD=./libtool --mode=link --tag=CC $(CC) $(CFLAGS) -g
JAVAC=@JAVAC@

all: $(LOCALBIN) @MAKE_LIBTARGETS@ $(LOCALBIN)/float.so

distribute: wwwdir doc tarballs

$(MPFRLIB).tar.bz2:
	echo "I can't find $(MPFRLIB), so I'm going to download it"
	(cd extern; wget --no-verbose http://www.mpfr.org/mpfr-current/mpfr-3.1.1.tar.bz2)

$(MPFILIB).tar.bz2:
	echo "I can't find $(MPFILIB), so I'm going to download it"
	(cd extern; wget --no-verbose https://gforge.inria.fr/frs/download.php/30129/mpfi-1.5.1.tar.bz2)

$(MPCLIB).tar.gz:
	echo "I can't find $(MPCLIB), so I'm going to download it"
	(cd extern; wget --no-verbose http://www.multiprecision.org/mpc/download/mpc-1.0.1.tar.gz)

$(CXSCLIB).tar.gz:
	echo "I can't find $(CXSCLIB), so I'm going to download it"
	(cd extern; wget --no-verbose http://www2.math.uni-wuppertal.de/~xsc/xsc/cxsc/cxsc-2-5-3.tar.gz)

$(FPLLLLIB).tar.gz:
	echo "I can't find $(FPLLLLIB), so I'm going to download it"
	(cd extern; wget --no-verbose http://xpujol.net/fplll/libfplll-4.0.1.tar.gz)

@MPFR_MAKELIB@

@MPFI_MAKELIB@

@MPC_MAKELIB@

@CXSC_MAKELIB@

@FPLLL_MAKELIB@

$(LOCALBIN):
	mkdir -p $(LOCALBIN)

$(LOCALBIN)/%.lo: src/%.C
	$(MYCXX) -d -o $@ -c $<

$(LOCALBIN)/%.lo: src/%.c
	$(MYCC) -d -o $@ -c $<

$(LOCALBIN)/float.so: @FLOAT_LO@
	$(MYLD) -module -o $(LOCALBIN)/float.la $+ @LEVMAR_LDFLAGS@ @LEVMAR_LIBS@ -rpath $(PWD)/$(LOCALBIN)
	cp $(LOCALBIN)/.libs/float.so $@

$(LOCALBIN)/mp_float.lo: src/mp_float.c src/mp_float.h

$(LOCALBIN)/mpfr.lo: src/mpfr.c src/mp_float.h

$(LOCALBIN)/mpfi.lo: src/mpfi.c src/mp_float.h

$(LOCALBIN)/mpc.lo: src/mpc.c src/mp_float.h

$(LOCALBIN)/fplll.lo: src/fplll.C

$(LOCALBIN)/mp_poly.lo: src/cpoly.C src/mp_poly.C

$(LOCALBIN)/cxsc_poly.lo: src/cpoly.C src/cxsc_poly.C src/cxsc_float.h

clean:
	rm -rf .version config.log $(LOCALBIN) `find doc -type l`

mrproper: clean
	rm Makefile config.h

configure: cnf/Makefile.in cnf/configure.ac
	(cd cnf; aclocal -Im4; autoconf; mv -f configure ..)

.version: PackageInfo.g
	grep '^Version :=' $< | cut -f2 -d'"' | tr -d '\n' > $@

doc: doc/chap0.html

doc/chap0.html: doc/float.xml doc/floatbib.xml lib/float.gd
	echo 'LoadPackage("float"); DOC@FLOAT();' | @GAP_EXEC@ -r -q -T -l ";$(PWDUU)"

checkblocks:
	grep '<#GAPDoc' PackageInfo.g gap/*d | awk -F'"' '{print $$2}' | sort > @@-blocks
	grep '<#Include' doc/float.xml | awk -F'"' '{print $$2}' | sort > @@-in
	comm -3 @@-blocks @@-in
	@rm @@-blocks @@-in

tarballs: .version doc
	mkdir -p zips
	tar -c -f zips/float-`cat .version`.tar.gz -z --exclude '*~' --exclude '.[a-z]*' --exclude 'config.[ls]*' --exclude 'float/Makefile*' --exclude autom4te.cache --exclude sandbox --exclude zips --exclude bin --exclude extern -C .. float
	ln -sf float-`cat .version`.tar.gz zips/float.tar.gz

wwwdir: doc/chap0.html tarballs
	cp PackageInfo.g doc/
	cp README doc/README.float
	(cd doc; git add *.html manual.pdf manual.css PackageInfo.g README.float; git commit -m 'New html files'; git push github master:gh-pages --force)
	rm doc/PackageInfo.g doc/README.float

#E Makefile.in . . . . . . . . . . . . . . . . . . . . . . . . . . . ends here
